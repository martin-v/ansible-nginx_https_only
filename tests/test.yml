---


- hosts: all
  remote_user: root
  tasks:
  - name: Update repositories cache
    apt: update_cache=yes
    changed_when: false

  # etckeeper setup
  - apt: package=etckeeper state=present
  - set_fact:
      revision: "{{ lookup('pipe', 'cd \"%s\" ; git rev-parse HEAD' % playbook_dir) }}"
  # Ubuntu sucks
  - lineinfile:
      dest: "/etc/etckeeper/etckeeper.conf"
      regexp: '^VCS="[^git][a-z]*"'
      state: absent
    when: ansible_distribution == 'Ubuntu'
  - lineinfile:
      dest: "/etc/etckeeper/etckeeper.conf"
      regexp: "^#?VCS=\"git\""
      line: "VCS=\"git\""
    when: ansible_distribution == 'Ubuntu'
  - shell: |
        git config --global user.email "you@example.com"
        git config --global user.name "Your Name"
        etckeeper uninit -f
        etckeeper init && etckeeper commit initial > /dev/null
    args:
      creates: /etc/.git


# run role under test
- hosts: all
  remote_user: root
  roles:
    - martin-v.nginx_https_only
    - martin-v.dehydrated


- hosts: all
  remote_user: root
  tasks:
  - name: Deploy nginx sslsite config
    template:
      src: templates/sslsite.conf.j2
      dest: /etc/nginx/sites-available/sslsite.conf
  - name: Enable nginx sslsite config
    file:
      src: /etc/nginx/sites-available/sslsite.conf
      dest: /etc/nginx/sites-enabled/sslsite.conf
      state: link
  - name: Restart nginx
    service: name=nginx state=restarted
    changed_when: false

  - name: Print webservers ssl certificate
    shell:
      cmd: "openssl s_client -showcerts -connect localhost:443 < /dev/null"
    changed_when: false
    tags:
    - skip_ansible_lint
